<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- As 3 meta tags acima *devem* vir em primeiro lugar dentro do `head`; qualquer outro conteúdo deve vir *após* essas tags -->
    <title>Panorama de Rede RNP</title>
    <link href="/static/css/style.css" rel="stylesheet">
    <!-- Bootstrap -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">

  </head>
  <body>
    <script src="https://d3js.org/d3.v5.min.js"></script> 
    <div class="container=fluid">
        <div class="topo">
            <div class="logotipo">
                <img src="/static/imagens/rnp_logo.png" alt="Logotipo RNP" style="width:120px;height:80px;">
            </div>
            <div class="menubox">
                <nav class="menu"> 
                        <ul>
                            <li><a href="#">Administracao</a></li>
                            <li><a href="#">Ajuda</a></li>
                        </ul>
                </nav>
            </div>
        </div>
    </div>

    <div class="container_imagem_panorama">
        <!--Div para a imagem do panorama-->
        <div class="imagem_panorama">
           
            {% if result %}
                <div id="chart"></div>

                <button class="btn btn-primary btn-sm" id="button0" onclick="startRoute(0)"
                 type="button">Rota 1</button>
                <button class="btn btn-primary btn-sm" id="button1" onclick="startRoute(1)" 
                type="button">Rota 2</button>
                <button class="btn btn-primary btn-sm" id="button2" onclick="startRoute(2)" 
                type="button">Rota 3</button>
                <button class="btn btn-primary btn-sm" id="button3" onclick="startRoute(3)" 
                type="button">Rota 4</button>

                <script>
                    let dados = {{ melhoresRotas }};
                    let nos = [];
                    let chart_width = 1200;
                    let chart_height = 1000;
                    let posicaoInicialX = 0;
                    let posicaoInicialY = 100;
                    let coordenadasDoEstado = [];
                    let melhoresRotasLista = {{ melhoresRotasLista }};
                    let listaEstados = [{"id": 1, "estado": "AC"}, {"id": 2, "estado": "AL"}, {"id": 3, "estado": "AM"}, {"id": 4, "estado": "AP"}, 
                                        {"id": 5, "estado": "BA"}, {"id": 6, "estado": "CE"}, {"id": 7, "estado": "DF"}, {"id": 8, "estado": "ES"}, 
                                        {"id": 9, "estado": "GO"}, {"id": 10, "estado": "MA"}, {"id": 11, "estado": "MG"}, {"id": 12, "estado": "MS"}, 
                                        {"id": 13, "estado": "MT"}, {"id": 14, "estado": "PA"}, {"id": 15, "estado": "PB"}, {"id": 16, "estado": "PE"}, 
                                        {"id": 17, "estado": "PI"}, {"id": 18, "estado": "PR"}, {"id": 19, "estado": "RJ"}, {"id": 20, "estado": "RN"}, 
                                        {"id": 21, "estado": "RO"}, {"id": 22, "estado": "RR"}, {"id": 23, "estado": "RS"}, {"id": 24, "estado": "SC"}, 
                                        {"id": 25, "estado": "SE"}, {"id": 26, "estado": "SP"}, {"id": 27, "estado": "TO"}];
                    let mudancaX = 1;
                    let Coordenate = function(id, x, y) {
                        this.parent = parent;
                        this.id = id;
                        this.x = x || 0;
                        this.y = y || 0;
                    }
                    for(let i = 0; i < Object.keys(dados).length; i++ ) {
                    nos.push(Object.keys(dados)[i]);      
                    }
                    let svg = d3.select('#chart')
                            .append('svg')
                            .attr('width',chart_width)
                            .attr('height', chart_height);
                    
                    let groupPath = svg.append('g')
                                    .attr('render-order', -1)
                                    .attr('id','groupPath');
                    
                    let groupCircle = svg.append('g')
                                    .attr('render-order', 1);
                let circle = groupCircle.selectAll('circle')
                        .data(nos)
                        .enter()
                        .append('circle')
                        .attr('r', 20)
                        .attr('cx',function(d, i){
                            if( i % 4 == 0 ) {
                                posicaoInicialX = 175;
                            }  else {
                                posicaoInicialX += 256; 
                            }
                            return posicaoInicialX;
                        })
                        .attr('cy', function(d, i) {
                            if(i % 4 == 0 && i != 0) {
                                posicaoInicialY += 200;
                            } else if(i == 0 ) {
                                posicaoInicialY = 100;
                            }
                            if( i % 4 == 0 ) {
                                posicaoInicialX = 175;
                            }  else {
                                posicaoInicialX += 256; 
                            }
                            Object.assign(coordenadasDoEstado, {[d]: new Coordenate(d, posicaoInicialX, posicaoInicialY)});
                    
                            return posicaoInicialY;
                        })
                        .attr('fill', '#7ED26D')
                        .attr('id', function(d){
                            return 'circle'+d;
                        })
                        .transition()
                        .duration(500)
                        .attr('cy',function(d, i){
                            i+=1;
                            if(i % 2 != 0) {
                                coordenadasDoEstado[d].y = coordenadasDoEstado[d].y - 50;
                            } 
                            return coordenadasDoEstado[d].y;
                        })
                        .attr('cx', function(d,i){
                            
                            if(mudancaX > 4 && mudancaX <= 8) {
                                coordenadasDoEstado[d].x = coordenadasDoEstado[d].x + 40;
                            } else if(mudancaX > 16 && mudancaX <= 20){
                                coordenadasDoEstado[d].x = coordenadasDoEstado[d].x + 40;
                            } else if(mudancaX > 24 && mudancaX <= 27) {
                                coordenadasDoEstado[d].x = coordenadasDoEstado[d].x + 40;
                            }
                            mudancaX += 1;
                            return coordenadasDoEstado[d].x;
                        });
                    let link = d3.line()
                            .x(function(d) { return d.x; })
                            .y(function(d) { return d.y; })
                    .curve(d3.curveLinear);
                    for(let i = 0; i < Object.keys(dados).length; i++) {
                        let keyNo = nos[i];
                        let ligacoesDiretas = dados[keyNo];
                        for(let j = 0; j < dados[keyNo].length; j++) {
                        let path = groupPath.append('path')
                        .transition()
                        .duration(1000)
                        .delay(1000)
                        .attr("d", function(d) {
                                if(ligacoesDiretas[j] != 0){   
                                    let noCorrodenadasOrigem = coordenadasDoEstado[keyNo];
                                    let noCoordenadasDestino = coordenadasDoEstado[ligacoesDiretas[j]];
                                    return "M" +(noCorrodenadasOrigem.x)+"," +noCorrodenadasOrigem.y +
                                    "L" +(noCoordenadasDestino.x) +","+noCoordenadasDestino.y;
                                }
                            })
                            .attr("class", "link")
                            .attr('id', function(d) {
                                if(ligacoesDiretas[j] != 0) {
                                    return 'line-'+keyNo+'-'+ligacoesDiretas[j];
                                }
                                return 'line';
                            });
                        }
                    }
                    let text = svg.selectAll('text')
                            .data(nos)
                            .enter()
                            .append('text')
                            .attr('x',function(d, i){
                                return coordenadasDoEstado[d].x - 8;
                            })
                            .attr('y', function(d,i) {
                                return coordenadasDoEstado[d].y + 3;
                            })
                            .text(function(d) {
                                let value = getCountryByCode(d);
                                return value[0].estado;
                            })
                            .attr('font-family', 'sans-serif')
                            .attr('font-size','15px')
                            .attr('fill','white')
                    
                    function getCountryByCode(id) {
                        return listaEstados.filter(
                            function(listaEstados){ return listaEstados.id == id });
                    }
                    function transform(d) {
                        return "translate(" + d.x + "," + d.y + ")";
                    }
                function startRoute(id) {
                        groupPath.selectAll('path')
                                .attr('class', 'link');
                        let button = d3.select('#button'+id)
                        .attr('class',function(){
                            let rotaEscolhida = melhoresRotasLista[id];
                            for(let i = 0; i < rotaEscolhida.length -1; i++) {
                                let startPoint = rotaEscolhida[i];
                                let endPoint = rotaEscolhida[i+1];
                                d3.select("#line-"+startPoint+'-'+endPoint).attr("class", "linkAnimation");
                            }
                            return 'green';
                        })     
                        
                }
                                  
             </script>

            {% else %}

                    <div id="chart"></div>

            {% endif %}

        </div>
        <!--Fim da Div para imagem panorama-->
        <div class="pesquisa_form"> 

                <form action="/rotas/montar" method="post">
                    {% csrf_token %}
                <label>Origem:</label>
                    <select name="origem">
                        {% for option in options %}
                        <option  value="{{option.id}}">{{ option.estado }}</option>
                        {% endfor %}
                    </select>
                    <br/><br/>
                    <label>Destino:</label>
                    <select name="destino">
                        {% for option in options %}
                        <option value="{{option.id}}">{{ option.estado }}</option>
                        {% endfor %}
                    </select>
                    <br/><br/>
                    <label>Data da Pesquisa:</label>
                    <input type="date" name="dataPesquisa"/>
                    <input class="btn btn-primary btn-sm" type="submit" value="Pesquisar" />      
                </form>
                <div class="painel_resultados">
                    <h3>Latência Miníma: </h3>
                    <h3>Latência Máxima: </h3>
                    <h3>Perda: </h3>
                    <div class="link_disponivel">
                        <h3>Link Disponível <img src="/static/imagens/checked.svg"></h3>
                </div>
                    <!--Fim do painel de informações sobre rota escolhida-->
                </div>
            </div>
        </div>
    <div class="footer">
        <p>copyright © 2019</p>
    </div>
<!-- jQuery (obrigatório para plugins JavaScript do Bootstrap) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<!-- Inclui todos os plugins compilados (abaixo), ou inclua arquivos separadados se necessário -->
<script src="/static/js/bootstrap.min.js"></script>
</body>
</html>